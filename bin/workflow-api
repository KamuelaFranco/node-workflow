#!/usr/bin/env node
// Copyright (c) 2016, Joyent, Inc.

// vim: set filetype=javascript :

var bunyan = require('bunyan');
var fs = require('fs');
var path = require('path');
var restify = require('restify');
var tritonTracer = require('triton-tracer');
var util = require('util');

var API = require('../lib/').API;

var levels = [
  bunyan.TRACE,
  bunyan.DEBUG,
  bunyan.INFO,
  bunyan.WARN,
  bunyan.ERROR,
  bunyan.FATAL
];

if (process.argv.length < 3) {
  console.error('Usage: [node] ' + process.argv[1] + ' path/to/config.json');
  process.exit(1);
} else {
  var config_file = path.resolve(process.argv[2]);
  fs.readFile(config_file, 'utf8', function (err, data) {
    if (err) {
      console.error('Error reading config file:');
      console.dir(err);
      process.exit(1);
    } else {
      try {
        var config = JSON.parse(data);
      } catch (e) {
        console.error('Error parsing config file JSON:');
        console.dir(e);
        process.exit(1);
      }

      config.log = bunyan.createLogger({
        name: 'workflow-api',
        serializers: restify.bunyan.serializers,
        streams: [{
          level: 'info',
          stream: process.stdout
        }]
      });

      tritonTracer.init({
        log: config.log
      });

      var api = new API(config);
      api.init(function () {
        api.log.info('API server up and running!');
      });

      // Increase/decrease loggers levels using SIGUSR2/SIGUSR1:
      var sigyan = require('sigyan');
      sigyan.add([api.log, api.server.log, api.backend.log]);
    }
  });
}
